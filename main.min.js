(() => {
    const $$ = mdui.JQ,
        $magnet = $$("#magnet"),
        $magnetDiv = $$("#magnet-div"),
        $clear = $$("#clear"),
        $progress = $$("#progress"),
        $historyBody = $$("#history-body");
    let wait;
    async function getTorrent(magnet) {
        const test = /^(?:magnet:\?xt=urn:btih:)?([0-9a-zA-Z]{32}|[0-9a-zA-Z]{40})(?:$|&)/.exec(String(magnet || $magnet.val()).trim());
        test ? ($magnet.prop("disabled", !0), $clear.prop("disabled", !0), await downloadTorrent(test[1]), $magnet.prop("disabled", !1), $clear.prop("disabled", !1)) : showErr(!0), $progress.hide()
    }

function ge() {
	location.href = "https://www.baidu.com/s?wd="+document.getElementById("text").value;
}

    function saveHistory(hash, title) {
        let history = localStorage.getItem("history");
        if (history = history ? JSON.parse(history) : {
                t: {},
                s: []
            }, !history.t[hash]) {
            for (history.t[hash] = title, history.s.unshift(hash); history.s.length > 20;) delete history.t[history.s.pop()];
            localStorage.setItem("history", JSON.stringify(history)), renderHistory()
        }
    }

    function renderHistory() {
        let history = localStorage.getItem("history");
        if (history && (history = JSON.parse(history)), !(history && history.s && history.s.length > 0)) return void $$("#history").hide();
        $$("#history").show();
        let historyHtml = "";
        for (const hash of history.s) historyHtml += `<tr><td class="mdui-ripple dl" hash="${hash}">${history.t[hash]}</td><td class="mdui-ripple mdui-text-center copy-td"><a class="copy-magnet" data-clipboard-text="magnet:?xt=urn:btih:${hash}">COPY</a></td></tr>`;
        $historyBody.html(historyHtml)
    }

    function showErr(show) {
        $magnetDiv[show ? "addClass" : "removeClass"]("mdui-textfield-invalid")
    }
    axios.get(`/r/status?t=${(new Date).getTime()}`).then(r => $$("#use-times").html(r.data.times)), $clear.on("click", () => {
        $magnet.val(""), showErr(!1)
    }), $$("#clear-history").on("click", () => {
        localStorage.removeItem("history"), renderHistory()
    }), $magnet.on("input", () => {
        showErr(!1), 0 != $magnet.val().length && ($progress.show(), clearTimeout(wait), wait = setTimeout(getTorrent, 500))
    }), renderHistory(), $historyBody.on("click", ".dl", (function(e) {
        downloadTorrent($$(this).attr("hash"))
    })), new ClipboardJS(".copy-magnet").on("success", e => {
        mdui.snackbar({
            message: `<span class="mdui-text-color-yellow">Copied</span> ${e.text}`,
            position: "right-bottom"
        })
    })
})();